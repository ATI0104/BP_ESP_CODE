<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Monitor Configuration</title>
</head>

<body>

    <h1>PV panel monitor configuration</h1>
    <form onsubmit="sendConfiguration(event)" method="post">
        <span id="note"></span>
        <label for="deveui"><br>DevEUI(MSB)</label>
        <input type="text" id="deveui" name="deveui" required>
        <label for="appkey"><br>JoinEUI(MSB)</label>
        <input type="text" id="appeui" name="appeui" required>
        <label for="appkey"><br>AppKey(MSB)</label>
        <input type="text" id="appkey" name="appkey" required>
        <input type="submit" value="Submit">
    </form>
    <h3>Download Configuration</h3>
    <button type="button" onclick="generatejson()">Download</button>
    <script>
        function getConfiguration() {
            fetch('/config')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('deveui').value = data.deveui;
                    document.getElementById('appeui').value = data.appeui;
                    document.getElementById('appkey').value = data.appkey;
                    if (data.appeui.length > 0) {
                        document.getElementById('deveui').disabled = true;
                        document.getElementById('appeui').disabled = true;
                        document.getElementById('note').innerHTML = "Device is already configured. You can only change the AppKey. If you want to change the DevEUI or JoinEUI, you need to reset the device by holding down the PRG button for 3s.";
                    } else {
                        if (data.deveui != "" && data.appeui != "" && data.appkey != "") {

                        }
                    }
                });
        }
        getConfiguration();
        function sendConfiguration(event) {
            event.preventDefault(); // Prevent the default form submission
            const deveui = document.getElementById('deveui').value;
            const appeui = document.getElementById('appeui').value;
            const appkey = document.getElementById('appkey').value;
            if (deveui.length != 16 || appeui.length != 16 || appkey.length != 32) {
                alert("Invalid input. Please check the input and try again.");
                return false;
            }
            fetch('/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    deveui: deveui,
                    appeui: appeui,
                    appkey: appkey
                })
            })
                .then(data => {
                    console.log('Success:', data);
                    alert("Configuration updated successfully")
                    return false;
                })
                .catch((error) => {
                    console.error('Unable to update configuration.\nError:', error);
                    return false;
                });
            return false;
        }
        function generatejson() {
            fetch('/config')
                .then(response => response.json())
                .then(data => {
                    var json = JSON.stringify(data);
                    var blob = new Blob([json], { type: "application/json" });
                    var url = URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.download = "config.json";
                    a.href = url;
                    a.textContent = "Download config.json";
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                });
        }
    </script>
</body>

</html>